steps:
  - name: node:16.13.1-alpine
    id: "install"
    dir: "functions"
    waitFor: ["-"]
    entrypoint: "npm"
    args: ["ci"]
  - name: node:16.13.1-alpine
    id: "setup-firebase-json"
    dir: "functions"
    waitFor: ["-"]
    entrypoint: "sh"
    args: ["-c", "cat firebase-cloudbuild.json > firebase.json"]
  - name: gcr.io/$PROJECT_ID/firebase
    id: "setup-environment"
    waitFor: ["-"]
    dir: "functions"
    args:
      [
        "functions:config:set",
        "--project=$PROJECT_ID",
        "calendly.access_token=",
        "calendly.base_url=",

        "mailchimp.api_key=",
        "mailchimp.server=",
        "mailchimp.default_list_id=",
        "mailchimp.career_list_id=",

        "sendgrid.api_key=",

        "contact_form.destination_email=",
        "career_form.destination_emails.0=",

        "recaptcha.secret_key=",

        "hubspot.api_key=",
        "hubspot.landing_deal_pipeline_name=",
        "hubspot.landing_deal_pipeline_stage=",
        "hubspot.blog_newsletter_id=",
      ]
  - name: gcr.io/$PROJECT_ID/firebase
    dir: "functions"
    waitFor: ["setup-firebase-json", "setup-environment", "install"]
    args: ["--debug", "deploy", "--project=$PROJECT_ID", "--only=functions"]

logsBucket: "$_LOGS_BUCKET"
timeout: 600s
options:
  logging: GCS_ONLY
